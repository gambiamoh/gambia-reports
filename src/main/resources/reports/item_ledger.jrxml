<?xml version="1.0" encoding="UTF-8"?>
<!-- Created with Jaspersoft Studio version 6.20.5.20250704-1505 using JasperReports Library version 6.20.5-3efcf2e67f959db3888d79f73dde2dbd7acb4f8e  -->
<jasperReport xmlns="http://jasperreports.sourceforge.net/jasperreports" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://jasperreports.sourceforge.net/jasperreports http://jasperreports.sourceforge.net/xsd/jasperreport.xsd" name="product_report" pageWidth="1220" pageHeight="595" orientation="Landscape" whenNoDataType="AllSectionsNoDetail" columnWidth="802" leftMargin="20" rightMargin="20" topMargin="20" bottomMargin="20" whenResourceMissingType="Error" uuid="1b2b2459-7c9e-4ef5-af66-d4167759aa90">
	<property name="com.jaspersoft.studio.data.defaultdataadapter" value="One Empty Record"/>
	<style name="Row" mode="Transparent">
		<conditionalStyle>
			<conditionExpression><![CDATA[$V{REPORT_COUNT} % 2 == 0]]></conditionExpression>
			<style backcolor="#F3F3F3"/>
		</conditionalStyle>
	</style>
	<parameter name="program" class="java.lang.String">
		<property name="displayName" value="Program"/>
		<property name="selectExpression" value="/api/programs"/>
		<property name="selectProperty" value="id"/>
		<property name="displayProperty" value="name"/>
		<property name="required" value="true"/>
	</parameter>
	<parameter name="geographicZone" class="java.lang.String">
		<property name="displayName" value="Geographic Zone"/>
		<property name="selectExpression" value="/api/geographicZones"/>
		<property name="selectProperty" value="id"/>
		<property name="displayProperty" value="name"/>
		<property name="required" value="true"/>
	</parameter>
	<parameter name="facility" class="java.lang.String">
		<property name="displayName" value="Facility"/>
		<property name="selectExpression" value="/api/facilities"/>
		<property name="selectProperty" value="id"/>
		<property name="displayProperty" value="name"/>
		<property name="required" value="false"/>
	</parameter>
	<parameter name="orderable" class="java.lang.String">
		<property name="displayName" value="Product"/>
		<property name="selectExpression" value="/api/orderables"/>
		<property name="selectProperty" value="id"/>
		<property name="displayProperty" value="fullProductName"/>
		<property name="required" value="false"/>
	</parameter>
	<parameter name="orderableFilter" class="java.lang.String" isForPrompting="false">
		<defaultValueExpression><![CDATA[($P{orderable} == null) ? (" ord.id is not NULL") : (" ord.id='"+$P{orderable}+"'::uuid")]]></defaultValueExpression>
	</parameter>
	<parameter name="facilityFilter" class="java.lang.String" isForPrompting="false">
		<defaultValueExpression><![CDATA[($P{facility} == null) ? (" fac.id is not NULL") : (" fac.id='"+$P{facility}+"'::uuid")]]></defaultValueExpression>
	</parameter>
	<parameter name="dateFrom" class="java.lang.String">
		<property name="displayName" value="Start Date"/>
		<property name="required" value="true"/>
	</parameter>
	<parameter name="dateTo" class="java.lang.String">
		<property name="displayName" value="End Date"/>
		<property name="required" value="true"/>
	</parameter>
	<queryString language="SQL">
		<![CDATA[WITH RECURSIVE geo_hierarchy AS (
    SELECT id
    FROM referencedata.geographic_zones
    WHERE id = $P{geographicZone}::uuid
    UNION ALL
    SELECT gz.id
    FROM referencedata.geographic_zones gz
    INNER JOIN geo_hierarchy gh ON gz.parentid = gh.id
)
SELECT
    rgz.name AS region_name,
    prog.name AS program,
    fac.name AS facility,
    ord.code AS product_code,
    ord.fullProductName AS product_name,
    r.stock_on_hand,
    r.issued,
    r.received
FROM (
    SELECT
        sc.programid,
        sc.facilityid,
        sc.orderableid,
        SUM(soh.stockonhand) AS stock_on_hand,
        SUM(COALESCE(issued.quantity, 0)) AS issued,
        SUM(COALESCE(received.quantity, 0)) AS received
    FROM stockmanagement.stock_cards sc
    INNER JOIN (
        SELECT DISTINCT ON (stockcardid)
            stockcardid,
            stockonhand
        FROM stockmanagement.calculated_stocks_on_hand
        WHERE processeddate <= $P{dateTo}::date
        ORDER BY stockcardid, occurreddate DESC
    ) soh ON sc.id = soh.stockcardid
    LEFT JOIN (
        SELECT
            stockcardid,
            SUM(quantity) AS quantity
        FROM stockmanagement.stock_card_line_items
        WHERE destinationid IS NOT NULL
          AND processeddate BETWEEN $P{dateFrom}::date
                                AND $P{dateTo}::date
        GROUP BY stockcardid
    ) issued ON issued.stockcardid = sc.id
    LEFT JOIN (
        SELECT
            stockcardid,
            SUM(quantity) AS quantity
        FROM stockmanagement.stock_card_line_items
        WHERE sourceid IS NOT NULL
          AND processeddate BETWEEN $P{dateFrom}::date
                                AND $P{dateTo}::date
        GROUP BY stockcardid
    ) received ON received.stockcardid = sc.id
    GROUP BY sc.programid, sc.facilityid, sc.orderableid
) r
JOIN referencedata.facilities fac ON fac.id = r.facilityid
INNER JOIN referencedata.geographic_zones gz ON fac.geographiczoneid = gz.id
LEFT JOIN referencedata.geographic_zones rgz ON gz.parentid = rgz.id
JOIN referencedata.programs prog ON r.programid = prog.id
INNER JOIN (
    SELECT DISTINCT ON (id)
        id,
        code,
        fullproductname
    FROM referencedata.orderables
    ORDER BY id, versionnumber DESC
) ord ON ord.id = r.orderableid
WHERE prog.id = $P{program}::uuid
  AND fac.geographiczoneid IN (SELECT id FROM geo_hierarchy)
  AND $P!{facilityFilter}
  AND $P!{orderableFilter}
ORDER BY prog.name, fac.name, ord.fullproductname;]]>
	</queryString>
	<field name="region_name" class="java.lang.String"/>
	<field name="program" class="java.lang.String"/>
	<field name="facility" class="java.lang.String"/>
	<field name="product_code" class="java.lang.String"/>
	<field name="product_name" class="java.lang.String"/>
	<field name="stock_on_hand" class="java.lang.Long"/>
	<field name="issued" class="java.lang.Long"/>
	<field name="received" class="java.lang.Long"/>
	<background>
		<band height="30" splitType="Stretch"/>
	</background>
	<title>
		<band height="80" splitType="Stretch">
			<staticText>
				<reportElement x="400" y="0" width="380" height="30" uuid="9425a6c9-4546-4c90-9119-7a7f300b6fb5"/>
				<textElement textAlignment="Left">
					<font size="15" isBold="true"/>
					<paragraph lineSpacing="Double" lineSpacingSize="2.0"/>
				</textElement>
				<text><![CDATA[Item Ledger Summary Report]]></text>
			</staticText>
			<textField>
				<reportElement x="0" y="40" width="380" height="20" uuid="f2dee407-b67a-426b-8ae1-9ed9eeb333cc"/>
				<textElement>
					<font size="12" isBold="true"/>
				</textElement>
				<textFieldExpression><![CDATA["Period: From " + $P{dateFrom} + " To "+ $P{dateTo}]]></textFieldExpression>
			</textField>
			<textField>
				<reportElement x="0" y="60" width="410" height="20" uuid="4a102e70-4d84-4abd-8efe-dccc6b4b1370"/>
				<textElement>
					<font size="12" isBold="true"/>
				</textElement>
				<textFieldExpression><![CDATA["Date:  " + (new SimpleDateFormat("dd-MM-yyyy")).format(new Date())]]></textFieldExpression>
			</textField>
		</band>
	</title>
	<columnHeader>
		<band height="40">
			<staticText>
				<reportElement mode="Opaque" x="0" y="0" width="40" height="40" backcolor="#A3EFD8" uuid="7972837a-4e14-4bc0-94ef-c9f465914ad5"/>
				<textElement textAlignment="Left" verticalAlignment="Middle">
					<font size="12" isBold="true"/>
				</textElement>
				<text><![CDATA[#]]></text>
			</staticText>
			<staticText>
				<reportElement mode="Opaque" x="40" y="0" width="160" height="40" backcolor="#A3EFD8" uuid="f1296dcd-3a59-4110-99af-f111c9e49196"/>
				<textElement textAlignment="Left" verticalAlignment="Middle">
					<font size="12" isBold="true"/>
				</textElement>
				<text><![CDATA[Program]]></text>
			</staticText>
			<staticText>
				<reportElement mode="Opaque" x="200" y="0" width="120" height="40" backcolor="#A3EFD8" uuid="146fd567-4977-4816-8a08-0b0840defb8a"/>
				<textElement textAlignment="Left" verticalAlignment="Middle">
					<font size="12" isBold="true"/>
				</textElement>
				<text><![CDATA[Region]]></text>
			</staticText>
			<staticText>
				<reportElement mode="Opaque" x="320" y="0" width="230" height="40" backcolor="#A3EFD8" uuid="ccd5ac68-c36f-477b-b2d4-390e36965d7d"/>
				<textElement textAlignment="Left" verticalAlignment="Middle">
					<font size="12" isBold="true"/>
				</textElement>
				<text><![CDATA[Facility]]></text>
			</staticText>
			<staticText>
				<reportElement mode="Opaque" x="550" y="0" width="130" height="40" backcolor="#A3EFD8" uuid="78cc39ab-0c2d-4904-8b3d-7007599a77c2"/>
				<textElement textAlignment="Left" verticalAlignment="Middle">
					<font size="12" isBold="true"/>
				</textElement>
				<text><![CDATA[Product code]]></text>
			</staticText>
			<staticText>
				<reportElement mode="Opaque" x="680" y="0" width="260" height="40" backcolor="#A3EFD8" uuid="51d4f6ca-49ce-4b4f-b05f-74bce56764a1"/>
				<textElement textAlignment="Left" verticalAlignment="Middle">
					<font size="12" isBold="true"/>
				</textElement>
				<text><![CDATA[Full Product Name]]></text>
			</staticText>
			<staticText>
				<reportElement mode="Opaque" x="940" y="0" width="80" height="40" backcolor="#A3EFD8" uuid="4f805543-e6e1-4349-9dc0-78d1e54b399a"/>
				<textElement textAlignment="Left" verticalAlignment="Middle">
					<font size="12" isBold="true"/>
				</textElement>
				<text><![CDATA[Received]]></text>
			</staticText>
			<staticText>
				<reportElement mode="Opaque" x="1020" y="0" width="80" height="40" backcolor="#A3EFD8" uuid="f70122c0-8d66-4a8b-ae62-05fcdc730d77"/>
				<textElement textAlignment="Left" verticalAlignment="Middle">
					<font size="12" isBold="true"/>
				</textElement>
				<text><![CDATA[Issued]]></text>
			</staticText>
			<staticText>
				<reportElement mode="Opaque" x="1100" y="0" width="80" height="40" backcolor="#A3EFD8" uuid="f1f9f3ac-ef40-472c-9b93-ca133dfe31d0"/>
				<textElement textAlignment="Left" verticalAlignment="Middle">
					<font size="12" isBold="true"/>
				</textElement>
				<text><![CDATA[SOH]]></text>
			</staticText>
		</band>
	</columnHeader>
	<detail>
		<band height="25" splitType="Immediate">
			<textField>
				<reportElement style="Row" mode="Opaque" x="0" y="0" width="40" height="25" uuid="c0fa3edb-4007-42f2-ba45-57ed0a648a44"/>
				<textElement textAlignment="Left" verticalAlignment="Middle">
					<font size="12"/>
				</textElement>
				<textFieldExpression><![CDATA[$V{REPORT_COUNT}]]></textFieldExpression>
			</textField>
			<textField>
				<reportElement style="Row" mode="Opaque" x="40" y="0" width="160" height="25" uuid="284efbde-beed-47dc-83aa-945fa278a9a7"/>
				<textElement textAlignment="Left" verticalAlignment="Middle">
					<font size="12"/>
				</textElement>
				<textFieldExpression><![CDATA[$F{program}]]></textFieldExpression>
			</textField>
			<textField>
				<reportElement style="Row" mode="Opaque" x="200" y="0" width="120" height="25" uuid="f6086392-26ff-4192-9d56-9f623692e302"/>
				<textElement textAlignment="Left" verticalAlignment="Middle">
					<font size="12"/>
				</textElement>
				<textFieldExpression><![CDATA[$F{region_name}]]></textFieldExpression>
			</textField>
			<textField>
				<reportElement style="Row" mode="Opaque" x="320" y="0" width="230" height="25" uuid="9c545440-13ed-46f5-ac83-a2bb222f31db"/>
				<textElement textAlignment="Left" verticalAlignment="Middle">
					<font size="12"/>
				</textElement>
				<textFieldExpression><![CDATA[$F{facility}]]></textFieldExpression>
			</textField>
			<textField>
				<reportElement style="Row" mode="Opaque" x="550" y="0" width="130" height="25" uuid="f755459a-f535-49c5-8414-70fef0372749"/>
				<textElement textAlignment="Left" verticalAlignment="Middle">
					<font size="12"/>
				</textElement>
				<textFieldExpression><![CDATA[$F{product_code}]]></textFieldExpression>
			</textField>
			<textField>
				<reportElement style="Row" mode="Opaque" x="680" y="0" width="260" height="25" uuid="d38e7969-2c23-4559-bf63-e851c0b6865a"/>
				<textElement textAlignment="Left" verticalAlignment="Middle">
					<font size="12"/>
				</textElement>
				<textFieldExpression><![CDATA[$F{product_name}]]></textFieldExpression>
			</textField>
			<textField>
				<reportElement style="Row" mode="Opaque" x="940" y="0" width="80" height="25" uuid="27a49dbe-a6e3-4082-821e-1ed5f7bdc39d"/>
				<textElement textAlignment="Right" verticalAlignment="Middle">
					<font size="12"/>
				</textElement>
				<textFieldExpression><![CDATA[$F{received}]]></textFieldExpression>
			</textField>
			<textField>
				<reportElement style="Row" mode="Opaque" x="1020" y="0" width="80" height="25" uuid="18219d9f-765d-4135-b5ec-27460d41c49a"/>
				<textElement textAlignment="Right" verticalAlignment="Middle">
					<font size="12"/>
				</textElement>
				<textFieldExpression><![CDATA[$F{issued}]]></textFieldExpression>
			</textField>
			<textField>
				<reportElement style="Row" mode="Opaque" x="1100" y="0" width="80" height="25" uuid="85b5c64d-ae0b-4a72-9e41-ef1f99ae2ec6"/>
				<textElement textAlignment="Right" verticalAlignment="Middle">
					<font size="12"/>
				</textElement>
				<textFieldExpression><![CDATA[$F{stock_on_hand}]]></textFieldExpression>
			</textField>
		</band>
	</detail>
	<pageFooter>
		<band height="30">
			<textField>
				<reportElement x="1080" y="17" width="100" height="13" uuid="a28068c5-49c0-4759-a022-b8fd4abaa2b6"/>
				<textElement textAlignment="Right"/>
				<textFieldExpression><![CDATA["Page "+$V{PAGE_NUMBER}]]></textFieldExpression>
			</textField>
		</band>
	</pageFooter>
</jasperReport>
